---
title: Seasonal comparisons
author: "MW Beck"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document
---

```{r setup, echo = FALSE, message = F, warning = F, results = 'hide'}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 9)

library(tidyverse)
library(tbeptools)
library(WRTDStidal)
library(lubridate)
library(mapview)
library(sf)
library(wqtrends)
library(patchwork)

data(rswqdat)
data(rsstatloc)
data(bswqdat)
# data(ppseg)

source('R/funcs.R')

# # segments
# ppseg <- ppseg %>% 
#   rename(area = Name) %>% 
#   group_by(area) %>% 
#   summarise() %>% 
#   st_buffer(dist = 0.0001) %>% 
#   st_buffer(dist = -0.0001) %>% 
#   mutate(
#     area = factor(area)
#   ) %>% 
#   filter(area == 'Area')

var <- 'chla'
ylb <- expression(paste('Chl-',italic(a),' (',italic('\u03bc'),'g ',L^-1,')'))

# prep data, 2006 to present, all epc data
bsdat <- bswqdat %>% 
  filter(source == 'epchc') %>% 
  filter(date >= as.Date('2006-01-01'))

alldat <- rswqdat %>% 
  filter(source == 'epchc') %>% 
  filter(station %in% bsdat$station) %>% 
  bind_rows(bsdat) %>% 
  select(station, date, var, val) %>%
  # mutate(
  #   date = floor_date(date, unit = 'month')
  # ) %>% 
  filter(var %in% c(!!var, 'sal')) %>% 
  # group_by(station, date, var) %>% 
  # summarise(
  #   val = median(val, na.rm = T), 
  #   .groups = 'drop'
  # ) %>% 
  arrange(station, date) %>% 
  spread(var, val) %>%
  rename(var = !!var)
  # inner_join(rsstatloc, ., by = 'station') %>% 
  # select(-source_lng, -source, -comment)


# WRTDStidal approach -----------------------------------------------------

# tomod <- alldat %>%
#   filter(station == sta) %>%
#   mutate(
#     res = log(var),
#     res = ifelse(is.infinite(res), NA, res),
#     lim = 0,
#   ) %>%
#   select(date, res, flo = sal, lim)
# 
# wrtdsmod <- tomod %>%
#   as.data.frame %>%
#   tidalmean %>%
#   modfit(flo_div = 10, fill_empty = T)
# 
# toplo <- wrtdsmod %>%
#   group_by(month) %>%
#   mutate(
#     momean = mean(norm0.5)
#   ) %>%
#   ungroup() %>%
#   mutate(
#     normresid = norm0.5 - momean
#   ) %>%
#   filter(month %in% c(3,4))

# 
# ggplot(toplo, aes(x = year, y = normresid)) +
#   geom_bar(aes(fill = normresid), stat = 'identity', colour = 'black') +
#   scale_fill_gradient2(low = 'lightblue', mid = "white", high = 'lightgreen', midpoint = 0) +
#   scale_y_continuous(ylabs2) +
#   geom_hline(yintercept = 0, colour = 'black') +
#   facet_wrap(~month) +
#   theme_bw() +
#   theme(
#     axis.title.x = element_blank(),
#     legend.position = 'none'
#   )
```

# {.tabset}

## WRTDStidal approach {.tabset .tabset-pills}

These plots show model predicted chlorophyll as a function of time, season, and salinity using a WRTDS approach described [here](http://fawda123.github.io/WRTDStidal/articles/overview.html).  The results provide an estimate of chlorophyll trends at different conditional percentiles of the response, in this case, the median and 90th percentile (tau = 0.5, 0.9).  A "flow-normalized" trend independent of salinity is also provided.  The top plot shows predicted chlorophyll (lines) for the different percentiles overlaid on the observed values (points).  The middle plot shows flow-normalized chlorophyll (lines) against the predictions (points).  Importantly, predictions for 2021 show little difference between the flow-normalized and predicted results, suggesting little influence of freshwater inputs into the system.  The bottom two plots show the flow-normalized results by day of year, with separate lines by year.  Note the uptick in 2021 flow-normalized predictions (thicker line) of chlorophyll for some stations. 

### Station 21

```{r, results = 'hide'}
wrtdsfunc(alldat, 21, ylb)
```

### Station 22

```{r, results = 'hide'}
wrtdsfunc(alldat, 22, ylb)
```

### Station 90

```{r, results = 'hide'}
wrtdsfunc(alldat, 90, ylb)
```

## wqtrends approach {.tabset .tabset-pills}

These plots show model-predicted chlorophyll (as a function of time) using a GAMs approach described [here](https://tbep-tech.github.io/wqtrends/articles/introduction.html).  The basic idea is to model a signal of a long-term seasonal and annual trend from an observed time series and then extract a seasonal metric of interest from the modelled signal.  The seasonal metric applies to an a priori window of time (e.g., March, April, etc.) and includes statistical uncertainty that can be used for additional hypothesis testing.  The results do not include any flow-adjusted or hydrologic inputs. 

### Station 21

```{r, results = 'hide'}
gamfunc(alldat, 21, ylb)
```

### Station 22

```{r, results = 'hide'}
gamfunc(alldat, 22, ylb)
```

### Station 90

```{r, results = 'hide'}
gamfunc(alldat, 90, ylb)
```
